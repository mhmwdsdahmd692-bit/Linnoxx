name: Linbet VPS v5 (Hybrid Secure Edition)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # ุฅุนุงุฏุฉ ุชุดุบูู ุชููุงุฆู ูู 6 ุณุงุนุงุช ูุถูุงู ุงูุงุณุชูุฑุงุฑูุฉ

jobs:
  linbet-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ๐ ุฅุนุฏุงุฏ ุงููุธุงู ุงูุฃุณุงุณู
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server curl nodejs npm git
          sudo systemctl enable ssh
          sudo systemctl start ssh
          echo "โ ุชู ุชูุนูู SSH ุจูุฌุงุญ ุจุฏูู ุชุนุฏูู ูููุฉ ุงููุฑูุฑ"

      - name: ๐ ุชูุนูู Tailscale VPN ูุชุฌุงูุฒ ุงูุญุธุฑ ุงูุฌุบุฑุงูู
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=linbet-vps-${{ github.run_id }} --ssh
          tsIP=$(tailscale ip -4 | head -n 1)
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "๐ ุชู ุชูุนูู Tailscale ุจูุฌุงุญ | IP: $tsIP"

      - name: ๐ง ุฅุนุฏุงุฏ ุจูุฆุฉ Linbet VPS
        run: |
          mkdir ~/linbet-vps
          cd ~/linbet-vps

          echo "PORT=3000" >> $GITHUB_ENV

          # ุฅูุดุงุก ููู ุงูุฎุงุฏู
          cat << 'EOF' > linbet-vps.js
          const http = require('http');
          const fs = require('fs');
          const os = require('os');
          const moment = require('moment');

          // ุฅุนุฏุงุฏุงุช ุนุงูุฉ
          const PORT = process.env.PORT || 3000;
          const LOG_PATH = './linbet_vps_log.txt';

          // ุฏุงูุฉ ูุชุณุฌูู ุงูุฃุญุฏุงุซ ูู ููู
          function logEvent(message) {
            const log = `[${moment().format('YYYY-MM-DD HH:mm:ss')}] ${message}\n`;
            fs.appendFileSync(LOG_PATH, log);
            console.log(log.trim());
          }

          // ุฎุงุฏู HTTP ุงูุฃุณุงุณู
          const server = http.createServer((req, res) => {
            if (req.method === 'POST') {
              let body = '';
              req.on('data', chunk => body += chunk);
              req.on('end', () => {
                try {
                  const data = JSON.parse(body);
                  logEvent(`๐ฉ ุฅุดุงุฑุฉ ุฌุฏูุฏุฉ ูู ุงูุฎุงุฏู | ุงููุณุชุฎุฏู: ${data.userId || 'unknown'} | ุงูุฌููุฉ: ${data.round || 'N/A'} | ุฏูุฉ: ${data.accuracy || 'N/A'}`);
                  
                  res.writeHead(200, { 'Content-Type': 'application/json' });
                  res.end(JSON.stringify({ status: 'ok', received: data }));
                } catch (err) {
                  logEvent(`โ ุฎุทุฃ ูู ุชุญููู JSON: ${err.message}`);
                  res.writeHead(400, { 'Content-Type': 'application/json' });
                  res.end(JSON.stringify({ error: 'Invalid JSON' }));
                }
              });
            } else if (req.method === 'GET') {
              // ููุทุฉ ูุญุต ุงูุญุงูุฉ
              res.writeHead(200, { 'Content-Type': 'application/json' });
              res.end(JSON.stringify({
                status: "โ Linbet VPS v5 Online",
                serverTime: moment().format(),
                hostname: os.hostname(),
                tailscaleIP: process.env.TAILSCALE_IP || "Not detected",
                message: "Connected to Linbet Backend Successfully"
              }));
            }
          });

          server.listen(PORT, () => {
            logEvent(`๐ Linbet VPS v5 ูุนูู ุนูู ุงููููุฐ ${PORT}`);
          });
          EOF

          # ุชุซุจูุช ูุฅุนุฏุงุฏ PM2 ูุชุดุบูู ุฏุงุฆู
          npm install pm2 -g
          pm2 start linbet-vps.js --name linbet-vps
          pm2 save
          echo "โ ุชู ุชุดุบูู Linbet VPS Node.js ุจูุฌุงุญ ุนุจุฑ PM2"

      - name: ๐ ูุฑุงูุจุฉ ูุงุณุชูุฑุงุฑูุฉ ุงูุชุดุบูู (Keep-Alive)
        run: |
          echo "โ๏ธ VPS ูุนูู ูู ูุถุน ุงููุฑุงูุจุฉ ุงููุณุชูุฑุฉ..."
          while true; do
            echo "[$(date)] VPS ูุง ูุฒุงู ูุนูู ุจูุฌุงุญ..."
            sleep 300
          done
